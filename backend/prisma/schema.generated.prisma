// datasource + generator only
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// NOTE: Prisma doesnâ€™t support `import` natively
// â†’ Weâ€™ll stitch all modules together before migration/generation
// For example, with a simple Node script or prisma-schema-split


enum UserRole {
  superuser
  visitor
  vendor
  admin
  instructor
  student
  management
}

enum CourseRoleType {
  lead
  ta
  guest
}

enum ResourceType {
  note
  video
  image
  file
  link
}

enum Visibility {
  public
  private
  courseOnly
}

enum BookingStatus {
  requested
  accepted
  declined
  cancelled
  completed
}

enum Category {
  enterprise
  institution
  online
}

enum Assessment{
    pending
    cancelled
    completed
    marked
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  action     String
  targetType String
  targetId   Int
  metadata   Json?
  createdAt  DateTime @default(now())
}

model AssessmentRecord {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  Int
  status    Assessment
  score     Int?
  feedback  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Attachment {
  id        Int      @id @default(autoincrement())
  owner   User @relation(fields: [ownerId], references: [id])
  ownerId   String
  storageKey String
  mimeType   String
  size      Int?
  createdAt DateTime @default(now())
}

model Booking {
  id            Int      @id @default(autoincrement())
  student       User     @relation("BookingStudent", fields: [studentId], references: [id])
  studentId     String
  instructor    User     @relation("BookingInstructor", fields: [instructorId], references: [id])
  instructorId  String
  course        Course   @relation(fields: [courseId], references: [id])
  courseId      Int
  slotStart     DateTime
  slotEnd       DateTime
  status        BookingStatus
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  organizationId Int
  organization Organization @relation(fields: [organizationId], references: [id])
}


model Course {
  id          Int         @id @default(autoincrement())
  title       String
  slug        String      @unique
  description String?
  visibility  Visibility
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  owner       User        @relation("CourseOwner", fields: [ownerId], references: [id])
  ownerId     String
  collaborators Json?

  courseRoles CourseRole[]
  resources   Resource[]
  forumThreads ForumThread[]
  bookings    Booking[]
  assessment  AssessmentRecord[]
}


model CourseRole {
  id       Int   @id @default(autoincrement())
  user     User  @relation(fields: [userId], references: [id])
  userId   String
  course   Course @relation(fields: [courseId], references: [id])
  courseId Int
  role     CourseRoleType
}

model ForumComment {
  id        String   @id @default(uuid())
  content   String
  postId    Int
  userId    String
  createdAt DateTime @default(now())
  deletedAt DateTime?  // ðŸ‘ˆ for soft-delete

  post ForumPost @relation(fields: [postId], references: [id])
  user   User @relation("UserComments", fields: [userId], references: [id])

}


model ForumThread {
  id              Int         @id @default(autoincrement())
  course          Course      @relation(fields: [courseId], references: [id])
  courseId        Int
  author          User       @relation("ForumThreadAuthor", fields: [authorId], references: [id])
  authorId        String
  title           String
  content         String
  acceptedAnswerId Int?
  tags            String[]
  viewsCount      Int         @default(0)
  upvotes         Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  posts           ForumPost[]
  organizationId  Int
  organization    Organization @relation(fields: [organizationId], references: [id])

  userId String
  user   User @relation("UserThreads", fields: [userId], references: [id])

}

model ForumPost {
  id          Int       @id @default(autoincrement())
  title       String
  thread      ForumThread @relation(fields: [threadId], references: [id])
  threadId    Int

  // Relation #1 â†’ Author of the post
  author      User      @relation("ForumPostAuthor", fields: [authorId], references: [id])
  authorId    String

  content     String
  upvotes     Int        @default(0)
  views          Int          @default(0)
  createdAt   DateTime   @default(now())

  // Replies (self-relation)
  parentPost    ForumPost? @relation("CommentReplies", fields: [parentPostId], references: [id])
  parentPostId  Int?
  replies       ForumPost[] @relation("CommentReplies")

  // Relation #2 â†’ General user (e.g., participant)
  user          User @relation("ForumPostUser", fields: [userId], references: [id])
  userId        String

  // Org scoping
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  comments       ForumComment[]   // ðŸ‘ˆ opposite of ForumComment.post
  deletedAt      DateTime?    // ðŸ‘ˆ for soft-delete

}


model Notification {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  type      String
  message     String
  isRead      Boolean   @default(false)
  payload   Json
  readAt    DateTime?
  createdAt DateTime @default(now())

  relatedPostId   Int?
  relatedThreadId Int?
  relatedUserId   String?
}

model Organization {
  id            Int      @id @default(autoincrement())
  name          String
  allowedDomain String   @unique
  address       String?
  contactEmail  String?
  contactPhone  String?
  website       String?
  description   String?
  createdAt     DateTime @default(now())
  deletedAt     DateTime?   // ðŸ‘ˆ for soft delete

  users         User[]
  bookings      Booking[]
  forumPosts    ForumPost[]
  forumThreads  ForumThread[]
}


model Payment {
  id          Int       @id @default(autoincrement())
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  method      String
  amount      Float
  currency    String
  status      String
  reference   String    @unique
  createdAt   DateTime  @default(now())
}


model Resource {
  id          Int      @id @default(autoincrement())
  course      Course   @relation(fields: [courseId], references: [id])
  courseId    Int
  uploader    User     @relation(fields: [uploaderId], references: [id])
  uploaderId  String
  title       String
  description String?
  type        ResourceType
  storageKey  String
  mimeType    String
  size        Int?
  duration    Int?
  previewUrl  String?
  visibility  Visibility
  createdAt   DateTime @default(now())
}


model Session {
  id         Int      @id @default(autoincrement())
  token      String   @unique
  lastActive DateTime
  userId     String
  isActive  Boolean  @default(true)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String?
  avatarUrl     String?
  passwordHash  String
  role          UserRole?
  reputation    Int      @default(0)  // ðŸ‘ˆ Gamified metric
  category      Category
  verified      Boolean      @default(false)
  blocked       Boolean      @default(false) // âœ… add this field
  orgName       String?
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime?    @updatedAt

  organization   Organization? @relation(fields: [organizationId], references: [id])
  organizationId Int?       // if Org also has uuid PK
  sessions       Session[]
  courses        Course[]     @relation("CourseOwner")
  courseRoles    CourseRole[]
  resources      Resource[]
  bookingsAsStudent     Booking[] @relation("BookingStudent")
  bookingsAsInstructor  Booking[] @relation("BookingInstructor")
  notifications  Notification[]
  activityLogs   ActivityLog[]
  attachments    Attachment[]
  payments       Payment[]
  forumPostsAsAuthor ForumPost[]    @relation("ForumPostAuthor")
  forumPostsAsUser   ForumPost[]    @relation("ForumPostUser")
  forumComments      ForumComment[] @relation("UserComments")
  forumThreadsAsAuthor ForumThread[] @relation("ForumThreadAuthor")
  forumThreadsAsUser  ForumThread[] @relation("UserThreads")
  assessment          AssessmentRecord[]

  refreshToken   String?
}
